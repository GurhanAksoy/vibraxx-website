import * as React from "react";
import { Volume2, VolumeX, BarChart3, X } from "lucide-react";
export type Phase = "READY" | "QUESTION" | "EXPLANATION";
export type RoundResult = { userName: string; userAvatar: string; correct: number; wrong: number; total: number; accuracy: number; };

const QUESTIONS = [
  { id: "1", q: "Which planet is known as the Red Planet?", a: "Mars", options: ["Mars", "Venus", "Jupiter", "Mercury"], exp: "Mars looks red because of iron oxide on its surface." },
  { id: "2", q: "Capital of Japan?", a: "Tokyo", options: ["Kyoto","Osaka","Tokyo","Nagoya"], exp: "Tokyo has been Japan's capital since 1868." },
];
const QUESTION_SECONDS = 6, EXPLANATION_SECONDS = 5, ROUND_SIZE = 50;

/* ---------- Audio ---------- */
function useSfx() {
  const ctx = React.useRef<AudioContext|null>(null);
  const gain = React.useRef<GainNode|null>(null);
  const [muted,setMuted]=React.useState(false);
  const [volume,setVolume]=React.useState(0.6);
  const ensure=()=>{ if(typeof window==="undefined")return null; if(!ctx.current){const AC=(window.AudioContext||(window as any).webkitAudioContext);ctx.current=new AC();gain.current=ctx.current.createGain();gain.current!.gain.value=muted?0:volume;gain.current!.connect(ctx.current.destination);}return ctx.current;};
  const play=async(name:string)=>{if(muted)return;const c=ensure();const g=gain.current;if(!c||!g)return;const res=await fetch(/sounds/.mp3);const arr=await res.arrayBuffer();const buf=await c.decodeAudioData(arr);const src=c.createBufferSource();src.buffer=buf;src.connect(g);src.start();};
  return { playCorrect:()=>play("correct"), playWrong:()=>play("wrong"), toggleMute:()=>{setMuted(m=>!m);if(gain.current)gain.current.gain.value=!muted?0:volume;}, changeVolume:(v:number)=>setVolume(v), muted, volume };
}

/* ---------- GamePlay ---------- */
export default function GamePlay({onRoundEnd,onPhaseChange}:{onRoundEnd:(r:RoundResult)=>void;onPhaseChange:(p:Phase)=>void;}) {
  const {playCorrect,playWrong,toggleMute,muted,volume,changeVolume}=useSfx();
  const [phase,setPhase]=React.useState<Phase>("READY");
  const [i,setI]=React.useState(0);
  const [left,setLeft]=React.useState(QUESTION_SECONDS);
  const [selected,setSelected]=React.useState<string|null>(null);
  const [correct,setCorrect]=React.useState(0);
  const [wrong,setWrong]=React.useState(0);
  const [answered,setAnswered]=React.useState(0);
  const q=QUESTIONS[i];
  const accuracy=answered?Math.round((correct/answered)*100):0;

  React.useEffect(()=>{onPhaseChange(phase);},[phase]);

  React.useEffect(()=>{ if(phase!=="QUESTION")return; if(left<=0){setPhase("EXPLANATION");return;} const t=setTimeout(()=>setLeft(s=>s-1),1000);return()=>clearTimeout(t); },[phase,left]);

  React.useEffect(()=>{ if(phase!=="EXPLANATION")return; const t=setTimeout(()=>{if(i+1<QUESTIONS.length){setI(x=>x+1);setLeft(QUESTION_SECONDS);setPhase("QUESTION");}else onRoundEnd({userName:"Guest",userAvatar:"",correct,wrong,total:answered,accuracy});},EXPLANATION_SECONDS*1000);return()=>clearTimeout(t);},[phase]);

  const choose=(opt:string)=>{ if(phase!=="QUESTION"||selected)return; setSelected(opt); const good=opt===q.a; setAnswered(a=>a+1); if(good){setCorrect(c=>c+1);playCorrect();}else{setWrong(w=>w+1);playWrong();} setTimeout(()=>setPhase("EXPLANATION"),QUESTION_SECONDS*1000-left*1000+500);};

  return (
  <main className="min-h-screen flex flex-col items-center justify-center bg-[#020817] text-white font-sans antialiased relative overflow-hidden">
    <div className="absolute top-2 left-0 right-0 flex flex-wrap justify-between items-center px-3 z-30">
      <button onClick={toggleMute} className="p-2 border border-[#21F3F3]/40 rounded-full bg-[#0b1120]/80 hover:scale-110 transition">{muted?<VolumeX className="w-4 h-4 text-red-400"/>:<Volume2 className="w-4 h-4 text-emerald-400"/>}</button>
      <div className="text-xs text-[#21F3F3] font-semibold tracking-wide flex items-center gap-1"><BarChart3 className="w-4 h-4"/><span>Progress</span></div>
      <button onClick={()=>onRoundEnd({userName:"Guest",userAvatar:"",correct,wrong,total:answered,accuracy})} className="p-1.5 border border-red-400/50 rounded-full bg-red-500/10 hover:bg-red-600/20"><X className="w-3.5 h-3.5 text-red-400"/></button>
    </div>

    {phase==="READY" && <div className="flex flex-col items-center gap-4 mt-16"><h1 className="text-3xl font-extrabold text-[#21F3F3] drop-shadow-lg">Global Live Quiz Arena</h1><p className="text-xs text-white/60 text-center max-w-sm">50 questions • 6s each • Answer fast, think sharp.</p><button onClick={()=>{setI(0);setCorrect(0);setWrong(0);setAnswered(0);setLeft(QUESTION_SECONDS);setPhase("QUESTION");}} className="mt-3 px-6 py-2.5 rounded-2xl bg-gradient-to-r from-[#21F3F3] to-[#F321C1] text-black font-bold shadow-[0_0_20px_rgba(243,33,193,0.7)] hover:scale-105 transition">Start Round</button></div>}

    {phase!=="READY" && <div className="mt-16 w-full max-w-xl px-4">
      <h2 className="text-center font-semibold text-lg mb-4">{q.q}</h2>
      <div className="grid grid-cols-2 gap-3">
        {q.options.map(o=>{
          const correctOpt=o===q.a, wrongSel=selected===o&&!correctOpt;
          let style="py-3 rounded-xl border transition text-sm";
          if(phase==="EXPLANATION"||left<=0){if(correctOpt)style+=" bg-emerald-500/20 border-emerald-400 text-emerald-300";else if(wrongSel)style+=" bg-red-500/20 border-red-400 text-red-300";else style+=" bg-[#0b1120]/70 border-white/10 text-white/70";}
          else if(selected===o)style+=" bg-[#21F3F3]/20 border-[#21F3F3] text-[#21F3F3]";
          else style+=" bg-[#0b1120]/70 border-[#21F3F3]/40 hover:bg-[#21F3F3]/10";
          return <button key={o} onClick={()=>choose(o)} disabled={!!selected||phase!=="QUESTION"} className={style}>{o}</button>;
        })}
      </div>
    </div>}

    {phase==="EXPLANATION" && <div className="fixed inset-0 bg-black/70 flex items-center justify-center"><div className="bg-[#020817]/95 border border-[#21F3F3]/60 rounded-xl p-5 max-w-sm"><h3 className="text-[#21F3F3] font-semibold mb-1 text-sm">Correct: {q.a}</h3><p className="text-xs text-white/70 mb-2">{q.exp}</p><p className="text-[10px] text-white/40">Next in {EXPLANATION_SECONDS}s...</p></div></div>}

    {phase!=="READY" && <div className="fixed bottom-3 left-1/2 -translate-x-1/2 w-[92%] sm:w-[70%] bg-[#020817]/95 border border-[#21F3F3]/40 rounded-xl py-2 px-3 flex items-center justify-between text-[10px] sm:text-xs font-semibold shadow-[0_0_16px_rgba(33,243,243,0.2)]">
      <div className="text-emerald-400">? {correct}</div>
      <div className="text-red-400">? {wrong}</div>
      <div className="text-cyan-300">?? {accuracy}%</div>
      <div className="text-white/70">Q {i+1}/{ROUND_SIZE}</div>
      <div className="text-yellow-300">? {left}s</div>
    </div>}
  </main>);
}
